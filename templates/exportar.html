{% extends "base.html" %}

{% block title %}Sincronizar Arduino{% endblock %}

{% block content %}
<style>
    /* Estilo para a caixa de log "terminal" */
    #log-box {
        background-color: #2c3e50; /* Cor escura */
        color: #ecf0f1; /* Texto claro */
        font-family: 'Courier New', Courier, monospace;
        font-size: 0.9em;
        padding: 15px;
        border-radius: 5px;
        height: 300px;
        width: 100%;
        overflow-y: scroll; /* Adiciona barra de rolagem */
        border: 1px solid #34495e;
        box-sizing: border-box; /* Garante que o padding não estoure a largura */
    }
    .sync-controls {
        display: flex;
        align-items: center;
        gap: 15px; /* Espaço entre os itens */
        margin-bottom: 20px;
    }
    #port-select {
        padding: 8px;
        font-size: 1em;
        border-radius: 5px;
        border: 1px solid #bdc3c7;
        flex-grow: 1; /* Faz o select ocupar o espaço */
    }
</style>

<h1>Sincronizar Dispositivo Arduino</h1>
<p>Envie a lista de matrículas do banco de dados diretamente para a memória do Arduino.</p>

<div class="sync-controls">
    <button id="btn-listar" class="btn">Listar Portas</button>
    <select id="port-select" disabled>
        <option>Clique em "Listar Portas" primeiro</option>
    </select>
    <button id="btn-sincronizar" class="btn" disabled>Sincronizar</button>
</div>

<h3>Log de Sincronização:</h3>
<pre id="log-box"></pre>

<script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
<script>
    // Conecta ao nosso servidor SocketIO
    const socket = io();

    // Mapeia os elementos do HTML
    const btnListar = document.getElementById('btn-listar');
    const btnSincronizar = document.getElementById('btn-sincronizar');
    const selectPort = document.getElementById('port-select');
    const logBox = document.getElementById('log-box');

    let isSyncing = false;

    // --- Função para adicionar logs na caixa ---
    function log(message) {
        logBox.textContent += message + '\n';
        // Auto-scroll para o final
        logBox.scrollTop = logBox.scrollHeight;
    }

    // --- Configuração dos Botões ---
    btnListar.addEventListener('click', () => {
        log('Procurando portas...');
        btnListar.disabled = true;
        btnSincronizar.disabled = true;
        socket.emit('listar_portas_request'); // Envia o evento para o servidor
    });

    btnSincronizar.addEventListener('click', () => {
        const selectedPort = selectPort.value;
        if (selectedPort) {
            isSyncing = true;
            log(`Iniciando sincronização com ${selectedPort}...`);
            btnListar.disabled = true;
            btnSincronizar.disabled = true;
            socket.emit('sincronizar_request', { port: selectedPort }); // Envia o evento com a porta
        } else {
            log('ERRO: Nenhuma porta foi selecionada.');
        }
    });

    // --- Ouvintes de Eventos do Servidor ---
    
    // Ouve a resposta com a lista de portas
    socket.on('listar_portas_response', (ports) => {
        selectPort.innerHTML = ''; // Limpa o dropdown
        if (ports.length > 0) {
            ports.forEach(port => {
                const option = document.createElement('option');
                option.value = port.device;
                option.textContent = `${port.device} (${port.description})`;
                selectPort.appendChild(option);
            });
            selectPort.disabled = false;
            btnSincronizar.disabled = false;
        } else {
            const option = document.createElement('option');
            option.textContent = 'Nenhum dispositivo encontrado';
            selectPort.appendChild(option);
            selectPort.disabled = true;
        }
        btnListar.disabled = false;
    });

    // Ouve as atualizações de log em tempo real
    socket.on('log_update', (data) => {
        log(data.msg);

        // Se a sincronização terminou (sucesso ou erro), reativa os botões
        if (data.msg.includes('concluída') || data.msg.includes('ERRO')) {
            isSyncing = false;
            btnListar.disabled = false;
            btnSincronizar.disabled = false;
        }
    });

    // Ouve o evento de conexão inicial
    socket.on('connect', () => {
        log('Conectado ao servidor de logs.');
    });

</script>
{% endblock %}